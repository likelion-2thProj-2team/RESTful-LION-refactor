<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>호텔 예약 페이지</title>
    <!-- 이모티콘 사용 -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script type="text/javascript"
            th:src="@{https://oapi.map.naver.com/openapi/v3/maps.js(ncpClientId=${clientId})}"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            /* 각 컨테이너의 높이를 자동으로 조정 */
            height: auto;
        }

        .tour-info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: auto;
            overflow: hidden; /* 컨테이너에서 벗어나는 내용을 숨김 */
        }

        .hotel-info, .room-info, .location-info, .review-info, .contact-info {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            max-width: 700px;
            width: 100%;
            /* 간격을 좁힘 */
            margin-bottom: 20px;
        }

        .tour-info {
            overflow: hidden; /* 가로 스크롤 부분에서 벗어나는 내용을 숨김 */
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            max-width: 700px;
            width: 100%;
            /* 간격을 좁힘 */
            margin-bottom: 20px;
        }

        .hotel-image {
            flex: 0 0 40%;
            margin-right: 30px;
        }

        .hotel-image img {
            width: 100%;
            border-radius: 10px;
        }

        .hotel-details, .room-details {
            flex: 0 0 60%;
        }

        .hotel-details h2, .room-details h2 {
            margin-top: 0;
            font-size: 24px;
            color: #333;
        }

        .hotel-details p, .room-details p {
            margin: 10px 0;
            font-size: 16px;
            color: #666;
        }

        .rating {
            display: flex;
            align-items: center;
            color: #f39c12;
        }

        .rating .fa-star {
            font-size: 20px;
        }

        .rating span {
            margin-left: 5px;
        }

        /* 호텔과 방 사이의 간격 */
        .space {
            margin-bottom: 20px;
        }

        /* 주변 관광지 */
        .horizontal-scroll {
            display: flex;
            flex-wrap: nowrap;
            overflow: auto;
            overflow-x: scroll;
            margin-left: -30px; /* 첫 번째 요소의 왼쪽 여백 조정 */
            padding-left: 30px; /* 스크롤 영역의 시작 부분에 패딩 추가 */
            padding-right: 30px;
            white-space: nowrap;
            width: 80%;
        }

        .tour-item {
            flex: 0 0 auto;
            display: inline-block;
            width: 200px; /* 너비 조정 가능 */
            height: auto;
            margin-right: 15px;
            vertical-align: top;
            background: #f4f4f4; /* 배경 색상 */
            border-radius: 8px; /* 모서리 둥글게 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
        }

        .tour-item img {
            width: 100%; /* 이미지 너비 */
            height: 100px; /* 이미지 높이 조정 */
            object-fit: cover; /* 이미지 비율 유지 */
        }

        .tour-item h3, .tour-item p {
            padding: 8px 12px; /* 내부 여백 */
            margin: 0; /* 외부 여백 제거 */
        }

        .tour-item h3 {
            font-size: 18px; /* 제목 글자 크기 */
            color: #333; /* 제목 글자 색상 */
        }

        .tour-item p {
            font-size: 15px; /* 내용 글자 크기 */
            color: #666; /* 내용 글자 색상 */
        }

        .load-more {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px; /* 버튼 상단 여백 */
            align-self: center;  /* 버튼을 자신의 영역 중앙에 위치 */
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* 입력란 */
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* 제출 버튼*/
        button[type="submit"] {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #0056b3;
        }

        /*    리뷰    */
        h3 { text-align: center; }

        .left-align-container {
            text-align: left;
            margin: 0px;
        }

        p {
            margin-top: 0;
            margin-bottom: 0rem;
        }

        .container {
            width: 80%;
            margin: 20px auto;
        }

        textarea, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 30px;
            padding: 5px;
            color: #ccc;
            cursor: pointer;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f90;
        }

        .stars-inner {
            font-size: 20px;
            color: #f90;
        }

    </style>
</head>
<body>

<!-- 호텔 -->
<div class="container">
    <div class="hotel-info">
        <div class="hotel-image">
            <!-- 호텔 이미지 삽입 필요 -->
            <img src="" alt="Hotel Image" id="hotelImage">
        </div>
        <div class="hotel-details">
            <h2 id="hotelName">호텔 이름</h2>
            <p id="hotelAddress"><i class="fas fa-map-marker-alt"></i> address</p>
            <p id="hotelTel"><i class="fas fa-phone"></i> tel</p>
            <!-- 별점 표시 조건 로직 필요(js) -->
            <div class="rating">
                <div id="ratingStars">

                </div>
                <!-- 별점 데이터 삽입 -->
                <span id="ratingScore">(별점 데이터)/5</span>
            </div>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 방 -->
<div class="container">
    <div class="room-info">
        <div class="room-details">
            <h2>방</h2>
            <ul id="roomList">

                <!-- 방 정보가 들어갈 곳 -->

            </ul>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 위치 -->
<div class="container">
    <div class="location-info">
        <h2>위치 정보</h2>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 주변 여행지 -->
<div class="tour-info-container">
    <div class="tour-info">
        <div class="tour-details">
            <h2>주변 여행지</h2>
            <ul id="tourList" class="horizontal-scroll">
                <!-- 관광지 정보가 들어갈 곳 -->
            </ul>
            <button id="loadMore" class="load-more">더 보기 &raquo;</button>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>
<section class="reviews" id="reviews">
    <div class="container">
        <h3>리뷰 작성하기</h3>
    </div>
    <div class="container">
        <div style="width: 60%; margin: auto;">
            <textarea id="reviewContent" class="form-control" placeholder="리뷰를 작성해주세요."></textarea>
        </div>
    </div>
    <div class="container">
        <p style="text-align: left; padding-left:10px; padding-top: 5px;" class="text-bold" >별점을 선택해주세요.</p>
    </div>
    <!-- 간격 추가 -->
    <div class="space"></div>
    <div class="container">
        <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5"/><label for="star5">★</label>
            <input type="radio" id="star4" name="rating" value="4"/><label for="star4">★</label>
            <input type="radio" id="star3" name="rating" value="3"/><label for="star3">★</label>
            <input type="radio" id="star2" name="rating" value="2"/><label for="star2">★</label>
            <input type="radio" id="star1" name="rating" value="1"/><label for="star1">★</label>
        </div>
    </div>
    <div class="container">
        <div class="left-align-container">
            <button onclick="submitReview()" class="btn btn-primary btn-sm">등록</button>
        </div>
    </div>
    <br>
    <!-- 간격 추가 -->
    <div class="space"></div>
    <h3>리뷰 리스트</h3>
    <div class="container">

        <table id="reviewsTable" class="table table-borderless" style="width: 60%; margin: 20px auto;">
            <thead>
            <tr>
                <th>작성자</th>
                <th>내용</th>
                <th>별점</th>
                <th> </th>
                <!--<th>작성일</th>-->
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>

    </div>
</section>
<!-- 간격 추가 -->
<!--<div class="space"></div>-->

<!--&lt;!&ndash; 문의 &ndash;&gt;-->
<!--<div class="container">-->
<!--    <div class="contact-info">-->
<!--    </div>-->
<!--</div>-->

<script>
    const hotelId = [[${hotelId}]];
    const checkIn = `[[${checkIn}]]`;
    const checkOut = `[[${checkOut}]]`;

    let mapX;
    let mapY;

    async function fetchHotelInfo() {
        const url = encodeURI(`/api/hotel/search/${hotelId}?checkIn=${checkIn}&checkOut=${checkOut}`)
        const response = await fetch(url);
        const data = await response.json();
        if (response.ok) {
            document.getElementById('hotelName').innerText = data.title;
            document.getElementById('hotelImage').src = data.firstImage;
            document.getElementById('hotelAddress').innerText = data.address;
            document.getElementById('hotelTel').innerText = data.tel;

            mapX = data.mapX;
            mapY = data.mapY;

            console.log(mapX);
            console.log(mapY);

            const hotelRating = data.avg_score;
            const ratingStars = document.getElementById('ratingStars');

            let cnt = 0;
            for (let i = 0; i < Math.round(hotelRating); i++) {
                const fullStar = document.createElement('i');
                fullStar.className = 'fas fa-star';
                ratingStars.appendChild(fullStar);
                cnt++;
            }
            for (let i = 0; i < 5 - cnt; i++) {
                const emptyStar = document.createElement('i');
                emptyStar.className = 'far fa-star';
                ratingStars.appendChild(emptyStar);
            }
            document.getElementById('ratingScore').innerText = hotelRating.toFixed(2);

            const roomUl = document.getElementById('roomList');
            data.rooms.forEach(room => {
                const roomLi = document.createElement('li');
                const roomName = document.createElement('h3');
                const roomContent = document.createElement('p');
                const roomPrice = document.createElement('p');

                roomName.innerText = room.name;
                roomContent.innerText = room.content;
                roomPrice.innerText = room.price;

                roomLi.appendChild(roomName);
                roomLi.appendChild(roomContent);
                roomLi.appendChild(roomPrice);

                roomUl.appendChild(roomLi);
            })

            displayMap(data.mapX, data.mapY);
        } else {
            console.log(data);
            alert('호텔 정보를 찾을 수 없습니다.');
            history.back();
        }
    }

    function displayMap(mapX, mapY) {
        var mapOptions = {
            center: new naver.maps.LatLng(mapY, mapX),
            zoom: 17
        };

        var map = new naver.maps.Map('map', mapOptions);

        // 마커 생성
        var position = new naver.maps.LatLng(mapY, mapX);
        var marker = new naver.maps.Marker({
            position: position,
            map: map
        });
    }

    // 주변 관광지 fetch
    let pageNum = 1;

     function loadTourInfo() {
        fetch(`/api/hotel/location/${mapX}/${mapY}/${pageNum}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(tour => {
                    // const tourList = document.getElementById('tourList');
                    const tourList = document.querySelector('.horizontal-scroll');
                    const li = document.createElement('li');
                    li.className = 'tour-item';
                    li.innerHTML = `
                            <img src="${tour.firstImage}" alt="Image of ${tour.title}">
                            <h3>${tour.title}</h3>
                            <p>${tour.address}</p>
                        `;
                    tourList.appendChild(li);
                });
                pageNum++;  // 다음 페이지 번호 증가

            })
            .catch(error => console.error('주변 관광지를 불러올 수 없습니다.:', error));
    }

    function updateScrollWidth(container) {
        const totalWidth = Array.from(container.children).reduce((total, child) => total + child.offsetWidth + 15 /* 마진 포함 */, 0);
        container.style.width = `${totalWidth}px`;
    }

    // 윈도우 로드 후 실행할 함수들
    window.onload = async function () {
        await fetchHotelInfo();
        fetchReviews();
        loadTourInfo();
    }

    // 더 보기 버튼 이벤트 핸들러
    document.getElementById('loadMore').addEventListener('click', loadTourInfo);


    // 리뷰
    async function submitReview() {
        const content = document.getElementById('reviewContent').value;
        const score = document.querySelector('input[name="rating"]:checked').value;
        const response = await fetch(`/api/${hotelId}/review`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, score})
        });

        if (response.ok) {
            alert('리뷰가 성공적으로 작성되었습니다.');
            await fetchReviews();
        } else {
            alert('리뷰 작성에 실패했습니다.');
        }
    }

    async function fetchReviews() {
        const response = await fetch(`/api/${hotelId}/review/list`);
        if (response.ok) {
            const reviews = await response.json();
            const tableBody = document.getElementById('reviewsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            reviews.forEach(review => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = review.nickname;
                row.insertCell(1).textContent = review.content;
                const starCell = row.insertCell(2);
                starCell.innerHTML = createStars(review.score);
                const actionCell = row.insertCell(3);
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'btn btn-outline-primary btn-sm';
                editButton.style.marginRight = "10px";
                editButton.addEventListener('click', () => editReview(review.id));
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-outline-danger btn-sm';
                deleteButton.addEventListener('click', () => deleteReview(review.id));
                actionCell.appendChild(deleteButton);

                // const dateCell = row.insertCell(4);
                // const reviewDate = new Date(review.createdAt); // 서버에서 받은 timestamp를 Date 객체로 변환
                // dateCell.textContent = reviewDate.toLocaleString();
            });
        } else {
            console.error('리뷰 불러오기에 실패하였습니다.');
        }
    }

    function createStars(score) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            starsHtml += `<span class="fa fa-star ${i <= score ? 'filled' : ''}" style="color: ${i <= score ? '#f90' : '#ccc'};"></span>`;
        }
        return starsHtml;
    }

    // 별점 선택기 생성 함수
    function createStarRating(currentScore) {
        const container = document.createElement('div');
        container.className = 'star-rating';
        container.style.display = 'flex';
        container.style.flexDirection = 'row'; // 별을 왼쪽에서 오른쪽으로 배열
        container.style.justifyContent = 'flex-start';

        for (let i = 1; i <= 5; i++) {
            const input = document.createElement('input');
            input.type = 'radio';
            input.id = 'editStar' + i;
            input.name = 'editRating';
            input.value = i;

            const label = document.createElement('label');
            label.htmlFor = 'editStar' + i;
            label.textContent = '★';
            label.style.cursor = 'pointer';
            label.style.color = (i <= currentScore) ? '#f90' : '#ccc'; // 왼쪽부터 currentScore까지 색상 채우기

            input.addEventListener('change', function() {
                updateStarDisplay(this.value);
            });

            container.appendChild(input);
            container.appendChild(label);
        }

        return container;
    }

    // 별점 표시 업데이트 함수
    function updateStarDisplay(selectedScore) {
        const stars = document.querySelectorAll('.edit-form-container .star-rating label');
        stars.forEach((star, index) => {
            star.style.color = (index < selectedScore) ? '#f90' : '#ccc';
        });
    }

    async function editReview(reviewId) {
        const response = await fetch(`/api/${hotelId}/review/${reviewId}`);
        const review = await response.json();

        if (response.ok) {
            const reviewContent = document.createElement('textarea');
            // reviewContent.value = review.content; // 기존 리뷰 내용
            reviewContent.placeholder = '수정할 내용을 작성해주세요.';
            reviewContent.className = 'form-control';

            const starContainer = createStarRating(review.score); // 별점 선택기 생성

            const submitButton = document.createElement('button');
            submitButton.textContent = '수정 완료';
            submitButton.className = 'btn btn-outline-primary btn-sm';
            submitButton.onclick = async () => {
                const selectedScore = document.querySelector('input[name="editRating"]:checked').value;
                await updateReview(reviewId, reviewContent.value, selectedScore);
            };

            // 폼 컨테이너 생성 및 추가
            const formContainer = document.createElement('div');

            formContainer.style.width = '50%'; // 폼의 너비 설정
            formContainer.style.padding = '20px'; // 내부 패딩 설정
            formContainer.style.margin = 'auto'; // 중앙 정렬
            formContainer.style.marginBottom = '50px';
            formContainer.style.border = '1px solid #ccc'; // 테두리 설정
            formContainer.style.borderRadius = '8px'; // 테두리 둥글게 설정
            formContainer.style.backgroundColor = '#f8f8f8'; // 배경색 설정

            formContainer.className = 'edit-form-container';
            formContainer.appendChild(reviewContent);
            formContainer.appendChild(starContainer);
            formContainer.appendChild(submitButton);

            // 이전에 생성된 수정 폼이 있다면 제거
            const existingForm = document.getElementById('editForm');
            if (existingForm) existingForm.remove();

            // 새로운 폼 추가
            document.body.appendChild(formContainer);
            formContainer.id = 'editForm';
        } else {
            alert('리뷰 정보를 불러오는 데 실패했습니다.');
        }
    }
    async function updateReview(reviewId, content, score) {
        const response = await fetch(`/api/${hotelId}/review/${reviewId}/update`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, score})
        });

        if (response.ok) {
            alert('리뷰가 성공적으로 수정되었습니다.');
            await fetchReviews(); // 목록을 새로고침
            const formContainer = document.getElementById('editForm');
            if (formContainer) {
                formContainer.parentNode.removeChild(formContainer); // 폼 제거
            }
        } else {
            alert('리뷰 수정에 실패했습니다.');
        }
    }


    async function deleteReview(reviewId) {
        if (confirm('리뷰를 정말 지우시겠습니까?')) {
            const response = await fetch(`/api/${hotelId}/review/${reviewId}/delete`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('리뷰가 성공적으로 지워졌습니다.');
                await fetchReviews();
            } else {
                alert('리뷰를 삭제하지 못하였습니다.');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', fetchReviews);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #333;
        }

        .tabs {
            overflow: hidden;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .tab-link {
            background-color: #f2f2f2;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }

        .tab-link:hover {
            background-color: #ddd;
        }

        .tab-content {
            display: none;
        }

        .tab-content h2 {
            margin-top: 0;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 50%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        input[type="submit"] {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 20px;
            position: relative;
        }

        .user-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-photo button {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* 버튼에 호버 효과를 추가합니다. */
        .user-photo button:hover {
            background-color: #0056b3;
        }

        .user-details {
            flex: 1;
        }

        /* 예약 현황 CSS */
        .reservation {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        .hotel-info {
            display: flex;
            align-items: center;
        }

        .hotel-photo {
            width: 150px;
            height: 150px;
            border-radius: 5px;
            margin-right: 20px;
        }

        .hotel-details {
            flex: 1;
        }

        .hotel-name {
            font-weight: bold;
        }

        .reservation-actions {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cancel-btn,
        .transfer-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .cancel-btn:hover,
        .transfer-btn:hover {
            background-color: #0056b3;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>마이페이지</h1>

    <!-- 탭 -->
    <div class="tabs">
        <button class="tab-link" onclick="openTab('userInfo')">프로필 정보</button>
        <button class="tab-link" onclick="openTab('changePassword')">비밀번호 변경</button>
        <button class="tab-link" onclick="fetchReservations(); openTab('reservationStatus');">예약 현황</button>
        <button class="tab-link" onclick="fetchReservations(); openTab('transferStatus');">양도 현황</button>
    </div>

    <!-- 탭 내용 -->
    <div id="userInfo" class="tab-content">
        <h2>프로필 정보</h2>
        <div class="user-info">
            <div class="user-photo">
                <img src="/static/socialIcons/empty_profile.png" alt="user_photo" id="userPhoto">
                <button onclick="editPhoto()">edit</button>
            </div>
            <div class="user-details">
                <p>닉네임: <span id="nicknameDisplay"></span></p>
                <p>이메일: <span id="emailDisplay"></span></p>
            </div>
        </div>
    </div>

    <div id="changePassword" class="tab-content">
        <h2>비밀번호 변경</h2>
        <label for="currentPassword">현재 비밀번호</label><br>
        <input type="password" id="currentPassword" name="current-password"><br>
        <label for="newPassword">새로운 비밀번호</label><br>
        <input type="password" id="newPassword" name="new-password"><br>
        <label for="confirmPassword">새로운 비밀번호 확인</label><br>
        <input type="password" id="confirmPassword" name="confirm-password"><br>
        <input type="submit" value="비밀번호 변경" onclick="changePassword()">
    </div>

    <!-- 예약 현황 -->
    <div id="reservationStatus" class="tab-content">
        <h2>예약 현황</h2>
        <div id="reservationList">
<!--            이하 내용은 동적으로 생성-->
<!--            <div class="reservation">-->
<!--                <div class="hotel-info">-->
<!--                    <img src="/static/tempHotel/h1.jpg" alt="hotel_image" class="hotel-photo">-->
<!--                    <div class="hotel-details">-->
<!--                        <p class="hotel-name">호텔명: <span>호텔 이름</span></p>-->
<!--                        <p>룸 이름: <span>스위트 룸</span></p>-->
<!--                        <p>체크인 날짜: <span>2024-05-01</span></p>-->
<!--                        <p>체크아웃 날짜: <span>2024-05-05</span></p>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="reservation-actions">-->
<!--                    <button class="cancel-btn">예약 취소</button>-->
<!--                    <button class="transfer-btn">예약 양도</button>-->
<!--                </div>-->
<!--            </div>-->
<!--            &lt;!&ndash; 다른 예약 정보도 동일한 방식으로 추가 &ndash;&gt;-->
        </div>
    </div>

    <!-- 양도 현황 -->
    <div id="transferStatus" class="tab-content">
        <h2>양도 현황</h2>
        <div id="transferList">
        </div>
    </div>
</div>

<script>
    function openTab(tabName) {
        let i, tabContent
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        document.getElementById(tabName).style.display = "block";
    }

    function editPhoto() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';

        fileInput.onchange = async function (event) {
            const file = event.target.files[0];
            const formData = new FormData();
            formData.append('image', file)
            if (file) {
                console.log('선택된 파일:', file);
                // 파일 전송
                const response = await fetch('/api/auth/profile-upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // 성공 시 새로고침
                    location.reload();
                } else {
                    const data = await response.json();
                    alert(data);
                }
            } else {
                alert('파일을 선택하세요.');
            }
        };

        fileInput.click();
    }

    // 프로필 정보 불러오기
    async function fetchMyProfile() {
        const response = await fetch('/api/auth/my-profile');
        const data = await response.json();
        if (response.ok) {
            if (data.profileImage != null) {
                document.getElementById('userPhoto').src = "/static/" + data.profileImage;
            }
            document.getElementById('nicknameDisplay').innerText = data.nickname;
            document.getElementById('emailDisplay').innerText = data.email;
        } else {
            console.log(data);
        }
    }

    // 비밀번호 변경
    async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
            return;
        }

        const response = await fetch('/api/auth/password/change', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        });

        if (response.ok) {
            alert('비밀번호가 변경되었습니다.');
            location.reload();
        } else {
            const data = await response.json();
            console.log(data);
            alert(data.message);
        }
    }

    async function fetchReservations() {
        const response = await fetch('/api/hotel/reservation/my');
        if (response.ok) {
            const reservations = await response.json();
            const reservationList = document.getElementById('reservationList');

            reservations.forEach(reservation => {
                // 예약 정보를 표시할 요소들을 생성합니다.
                const reservationDiv = document.createElement('div');
                reservationDiv.classList.add('reservation');

                const hotelInfoDiv = document.createElement('div');
                hotelInfoDiv.classList.add('hotel-info');

                const hotelPhoto = document.createElement('img');
                hotelPhoto.src = `/static/${reservation.hotelImage}`;
                hotelPhoto.alt = 'hotel_image';
                hotelPhoto.classList.add('hotel-photo');

                const hotelDetailsDiv = document.createElement('div');
                hotelDetailsDiv.classList.add('hotel-details');

                const hotelNameP = document.createElement('p');
                hotelNameP.innerHTML = `호텔명: <span>${reservation.hotelName}</span>`;

                const roomNameP = document.createElement('p');
                roomNameP.innerHTML = `룸 이름: <span>${reservation.roomName}</span>`;

                const checkinDateP = document.createElement('p');
                checkinDateP.innerHTML = `체크인 날짜: <span>${reservation.checkIn}</span>`;

                const checkoutDateP = document.createElement('p');
                checkoutDateP.innerHTML = `체크아웃 날짜: <span>${reservation.checkOut}</span>`;

                const statusP = document.createElement('p');
                statusP.innerHTML = '`상태: <span>${reservation.status}</span>`';

                hotelDetailsDiv.appendChild(hotelNameP);
                hotelDetailsDiv.appendChild(roomNameP);
                hotelDetailsDiv.appendChild(checkinDateP);
                hotelDetailsDiv.appendChild(checkoutDateP);
                hotelDetailsDiv.appendChild(statusP);

                hotelInfoDiv.appendChild(hotelPhoto);
                hotelInfoDiv.appendChild(hotelDetailsDiv);

                const reservationActionsDiv = document.createElement('div');
                reservationActionsDiv.classList.add('reservation-actions');

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '예약 취소';
                cancelBtn.classList.add('cancel-btn');

                const transferBtn = document.createElement('button');
                transferBtn.textContent = '예약 양도';
                transferBtn.onclick = function () {
                    openTransferWindow(reservation.id);
                }
                transferBtn.classList.add('transfer-btn');

                reservationActionsDiv.appendChild(cancelBtn);
                reservationActionsDiv.appendChild(transferBtn);

                reservationDiv.appendChild(hotelInfoDiv);
                reservationDiv.appendChild(reservationActionsDiv);

                reservationList.appendChild(reservationDiv);

            });
        } else {
            console.log('예약 정보를 가져오는 데 실패했습니다.');
        }
    }

    async function fetchTransfer() {
        const response = await fetch('/api/hotel/reservation/transfer/pending');
        if (response.ok) {
            const transfers = await response.json();
            console.log(transfers);
            const transferList = document.getElementById('transferList');

            transfers.forEach(reservation => {
                const reservationDiv = document.createElement('div');
                reservationDiv.classList.add('reservation');

                const hotelInfoDiv = document.createElement('div');
                hotelInfoDiv.classList.add('hotel-info');

                const hotelPhoto = document.createElement('img');
                hotelPhoto.src = `/static/${reservation.hotelImage}`;
                hotelPhoto.alt = 'hotel_image';
                hotelPhoto.classList.add('hotel-photo');

                const hotelDetailsDiv = document.createElement('div');
                hotelDetailsDiv.classList.add('hotel-details');

                const hotelNameP = document.createElement('p');
                hotelNameP.innerHTML = `호텔명: <span>${reservation.hotelName}</span>`;

                const roomNameP = document.createElement('p');
                roomNameP.innerHTML = `룸 이름: <span>${reservation.roomName}</span>`;

                const checkinDateP = document.createElement('p');
                checkinDateP.innerHTML = `체크인 날짜: <span>${reservation.checkIn}</span>`;

                const checkoutDateP = document.createElement('p');
                checkoutDateP.innerHTML = `체크아웃 날짜: <span>${reservation.checkOut}</span>`;

                const statusP = document.createElement('p');
                statusP.innerHTML = '`상태: <span>${reservation.status}</span>`';

                hotelDetailsDiv.appendChild(hotelNameP);
                hotelDetailsDiv.appendChild(roomNameP);
                hotelDetailsDiv.appendChild(checkinDateP);
                hotelDetailsDiv.appendChild(checkoutDateP);
                hotelDetailsDiv.appendChild(statusP);

                hotelInfoDiv.appendChild(hotelPhoto);
                hotelInfoDiv.appendChild(hotelDetailsDiv);

                const reservationActionsDiv = document.createElement('div');
                reservationActionsDiv.classList.add('reservation-actions');

                const transferBtn = document.createElement('button');
                transferBtn.textContent = '양도 받기';
                transferBtn.onclick = function () {
                    //결제 기능
                }
                transferBtn.classList.add('transfer-btn');

                reservationActionsDiv.appendChild(transferBtn);
                reservationDiv.appendChild(reservationActionsDiv);
                transferList.appendChild(reservationDiv);
            });
        } else {
            console.log('양도 정보를 가져오는 데 실패했습니다.');
        }
    }

    function initialize() {
        fetchMyProfile();
        fetchReservations(); // 예약 정보 가져오기
        fetchTransfer();
        openTab('userInfo');
    }

    function openTransferWindow(reservationId) {
        var url = '/my-page/reservation/transfer?grantorReservationId=' + reservationId;
        window.open(url, 'TransferWindow', 'width=600,height=800');
    }

    initialize();

</script>
</body>
</html>
